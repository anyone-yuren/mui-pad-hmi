import{R as g,r as j,j as u}from"./index-37af907f.js";import"./popupAction.styled-7c616d08.js";import{K as d,S as C,L as P,I as F,R as I}from"./ReactKonvaCore-a5150e1f.js";import{u as A}from"./index-fa453ff5.js";import{u as V}from"./map-b36eff15.js";import"./tslib.es6-9d30b114.js";import"./ResizeObserver.es-0f9f8adb.js";let h=null,w=0;const Q=K=>{g.useState(!1);const[O,X]=g.useState(1),[R,W]=g.useState({x:0,y:0}),{agvPosition:p,lockAgvView:f}=V(e=>({agvPosition:e.agvPosition,lockAgvView:e.lockAgvView})),s=g.useRef(null),m=g.useRef(null),[v,D]=g.useState({width:2400,height:2400,offsetY:0,offsetX:0}),[x,E]=g.useState(void 0),n=A(s);j.useEffect(()=>{n&&n.width&&n.height&&D({...v,offsetY:-(((n==null?void 0:n.width)||2)/2),offsetX:((n==null?void 0:n.height)||2)/2})},[n]),j.useEffect(()=>{const e=m.current,t=new d.Tween({node:e,duration:5,x:-p.y,y:p.x,easing:d.Easings.Linear});if(!f){new d.Tween({node:e,duration:5,x:e.x(),y:e.y(),easing:d.Easings.Linear}).finish();return}t.play()},[p,f]);const M=e=>{e.evt.preventDefault(),console.log("奇葩的滚轮事件开始出发",f);const t=1.1,o=e.target.getStage(),r=o.scaleX(),l=o.getPointerPosition(),a={x:(l.x-o.x())/r,y:(l.y-o.y())/r};let c=e.evt.deltaY>0?r/t:r*t;X(c),o.scale({x:c,y:c});const y={x:l.x-a.x*c,y:l.y-a.y*c};o.position(y),o.batchDraw()},T=e=>{e.evt.preventDefault();const t=e.evt.touches[0],o=e.evt.touches[1];if(!f&&t&&o){console.log("[stationStage.tsx] 地图TouchMove双指事件 触发"),s.current.isDragging()&&s.current.stopDrag();const r={x:t.clientX,y:t.clientY},l={x:o.clientX,y:o.clientY};if(!h){h=S(r,l);return}const a=S(r,l),c=Y(r,l);w||(w=c);const y={x:(a.x-s.current.x())/s.current.scaleX(),y:(a.y-s.current.y())/s.current.scaleX()};let i=s.current.scaleX()*(c/w);console.log("scale",i),i>2&&(i=2),i<.5&&(i=.5),s.current.scaleX(i),s.current.scaleY(i);const b=a.x-h.x,L=a.y-h.y,k={x:a.x-y.x*i+b,y:a.y-y.y*i+L};s.current.position(k),w=c,h=a}},Y=(e,t)=>Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)),S=(e,t)=>({x:(e.x+t.x)/2,y:(e.y+t.y)/2});return g.useEffect(()=>{const e=new Image;e.src="../../../../assets/map.png",e.onload=()=>{console.log("image",e.width,e.height),E(e)}},[]),u.jsx(u.Fragment,{children:u.jsx("div",{style:{position:"absolute",left:0,top:0,width:"100%",height:"100%",overflow:"hidden",background:"#F5F5F5"},ref:s,children:u.jsxs(C,{...v,...R,draggable:!f,ref:m,rotationDeg:-90,onWheel:M,onTouchMove:T,children:[u.jsx(P,{children:x&&u.jsx(F,{image:x,x:0,y:0,offsetX:x.width/2,offsetY:x.height/2})}),u.jsx(P,{children:u.jsx(I,{x:0,y:0,width:10,height:10,fill:"red"})})]})})})};export{Q as default};
